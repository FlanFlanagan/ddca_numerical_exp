\documentclass[12pt,letterpaper]{article}
\usepackage{draftwatermark}
\SetWatermarkText{DRAFT}
\SetWatermarkScale{1}
%Note to Self:
%When Decommission? - after two months of feeling useless or right away?

\usepackage[utf8]{inputenc}
\usepackage[letterpaper,margin=1in]{geometry}
\usepackage{caption} % for table captions

\usepackage{amsmath} % for multi-line equations and piecewises
\usepackage{indentfirst} % to indent after a section
\usepackage{setspace}
\usepackage{times}
\usepackage{graphicx}
\usepackage{textcomp}
\usepackage{xspace}
\usepackage{verbatim} % for block comments
\usepackage{subfig} % for subfigures
\usepackage{enumitem} % for a) b) c) lists
\newcommand{\Cyclus}{\textsc{Cyclus}\xspace}%
\newcommand{\Cycamore}{\textsc{Cycamore}\xspace}%
\usepackage{tabularx}

\newcolumntype{b}{X}
\newcolumntype{s}{>{\hsize=.5\hsize}X}
\newcolumntype{m}{>{\hsize=.75\hsize}X}
\usepackage{titling}
\usepackage{minted}

\newcommand{\subtitle}[1]{%
  \posttitle{%
    \par\end{center}
    \begin{center}\large#1\end{center}
    \vskip0.5em}%
}
\usepackage{tikz}


\usetikzlibrary{shapes.geometric,arrows}
\tikzstyle{process} = [rectangle, rounded corners, minimum width=3cm, minimum height=1cm,text centered, draw=black, fill=blue!30]
\tikzstyle{arrow} = [thick,->,>=stealth]


\graphicspath{{images/}}
 
\usepackage[font={footnotesize,it}]{caption}
 



\setlength{\parindent}{15pt} % Default is 15pt.




\fontfamily{ptm}\selectfont

\title{Numerical Experiments for Verifying Demand Driven Deployment Algorithms}
\subtitle{Draft 2}
\author{Jin Whan Bae, Gwendolyn Chee, Kathryn Huff}
\date{2017-10-11}


\begin{document}
	\maketitle
	\hrule

\section{Introduction}
The Demand-Driven Cycamore Archetype project (NEUP-FY16-10512) aims to develop \Cycamore demand-driven deployment capabilities.
The project plans to use non-optimizing, deterministic-optimizing and stochastic-optimizing prediction algorithms.

These prediction models are being developed by the University of South Carolina. In this report, we discuss numerical experiments for testing the non-optimizing, deterministic optimizing and stochastic optimizing methods. The numerical experiments will be designed for both the once through nuclear fuel cycle and advanced fuel cycles. 

\section{Once through Nuclear Fuel Cycle}
\begin{figure}[H]
\caption{Simplified once through nuclear fuel cycle used in these numerical 
experiments.}
\begin{tikzpicture}[node distance=4.7cm]
\node (source) [process] {\texttt{Source}};
\node (enrichment) [process, right of=source] {\texttt{Enrichment}};
\node (reactor) [process, right of=enrichment]{\texttt{Reactor}};
\node (sink) [process, right of=reactor]{\texttt{Sink}};

\draw [arrow] (source) -- (enrichment); 
\draw [arrow] (enrichment) -- (reactor);
\draw [arrow] (reactor) -- (sink);
\end{tikzpicture}
\end{figure}

In the simple simulation at the core of the numerical experiments, the 
once-through fuel cycle is simplified to have 4 components: \texttt{Source}, 
\texttt{Enrichment}, \texttt{Reactor} and \texttt{Sink}. However, in a true 
once-through fuel cycle, there are more than 4 components. Other components 
typically include milling, conversion, fuel fabrication etc. However, this 
simplified fuel cycle will be sufficient to evaluate the algorithm for all 
cases. 

\subsection{Input File Specification}
This section describes expectations for \Cyclus input specifications regarding 
this archetype. \Cyclus uses XML input files. For these numerical experiements, 
we assume the demand-driven deployment archetype is an \texttt{INSTITUTION}, 
since it governs deployment and decommission of facilities.

The user must only define the reactor prototype and reactor deployment 
parameter parameters.
The remaining fuel facilities,
both front end and back end, must be recognized by the \texttt{INSTITUTION} archetype
based on each prototypes' in-and-out commodities.
Then the recognized, or `connected' fuel cycle facilities deploy
with demand.
If an input file does not have the necessary `connections' for the 
reactor to receive fuel, we expect an error to be thrown. 

The input file must define reactor prototype to be deployed. There can be 
multiple reactors. An example follows.

\begin{minted}{xml}
<institution>
      <name>NO_ddd</name>
       <config><NO_ddd/></config>
      <reactor_list>
        <val>lwr</val>
        <val>sfr</val>
        <val>mox_lwr</val>
      </reactor_list>
\end{minted}

Then deployment of the reactors is defined, and the user
is given the option to manually define the deployment(DeployInst):
\begin{minted}{xml}
      <deployment>
      <type>manual</type>

        <build_times>
          <val>1</val>
          <val>10</val>
          <val>20</val>
          <val>40</val>
        </build_times>
        <n_build>
          <val>3</val>
          <val>3</val>
          <val>3</val>
          <val>3</val>
        </n_build>
        <lifetimes>
          <val>960</val>
          <val>960</val>
          <val>960</val>
          <val>960</val>
        </lifetimes>
      </deployment>

    </institution>
\end{minted}

If instead the institution deploys reactors according to a piecewise function, 
the institution must deploy reactors according to power demand (GrowthRegion) 
and the fuel cycle facilities must follow:

\begin{minted}{xml}
      <deployment>
      <type>growth</type>

      <growth>
        <piecewise_function>
              <piece>
                <start>0</start>
                <function>
                  <type>linear</type>
                  <params>1 2</params>
                </function>
              </piece>
        </piecewise_function>
      </growth>
      
      </deployment>

    </institution>
\end{minted}

\subsection{Simple Scenario for Testing}

A simple scenario definition is given n this section. A predefined \texttt{Reactor}
is deployed at timestep one and three. One of each of the front-end
fuel cycle facilities 
(\texttt{Source}, \texttt{Enrichment}, \texttt{FuelFab}) is deployed initially 
and can supply enough fuel
for the operation of one reactor. A \texttt{Sink} can hold enough
for two batches of fuel. The specifics are listed below:

\begin{table}[h]
     \centering
    \begin{tabularx}{\textwidth}{bbb}
       \hline
       Simulation Parameters & Value & Units \\
       \hline
       Duration & 7 & timesteps \\
       Deploy Reactors & 1, 3 & timesteps \\
       Natural U Composition & 0.71\% U235 & \\
       Tails Assay & 0.003 & \% U235 \\
       Fuel Enrichment & 4 & \% U235 \\
       Enrichment throughput & 300 & $\frac{kg}{month}$\\
       Enrichment SWU Capacity & 2000 & $\frac{SWU}{month \cdot}$ \\
       Source Throughput & 3000 & $\frac{kg}{month}$\\
       Sink Capacity & 200 &  $kg$ \\
       \hline
    \end{tabularx}
    \caption {Simulation Parameters}
    \label{tab:reactor}
\end{table}

\begin{table}[h]
    \centering
    \begin{tabularx}{\textwidth}{bbb}
       \hline
       Reactor Parameters & Value & Units \\
       \hline
       Cycle Time & 2 & timesteps \\
       Refuel Time & 1 & timesteps \\
       Lifetime & 6 & timesteps \\
       Power Capacity & 1000 & MWe \\
       Assembly Size & 100 & kg \\
       \# assemblies per core & 3 & \\
       \# assemblies per batch & 1 & \\
       \hline
    \end{tabularx}
    \caption {Reactor Parameters}
    \label{tab:reactor}
\end{table}


An example input file with the facility and simulation
definitions can be found in the input directory of this repository.

\newpage
\subsection{Analytical Solution}
The simple scenario is solve analytically.

\begin{table}[h]
    \centering
    \begin{tabularx}{\textwidth}{ssmmmb}
       \hline
       Timestep & Fuel [kg] & Enrichment [$\frac{SWU}{month}$]& Source [$\frac{kg}{month}$] & Sink Capacity [kg] & Note\\
       \hline
       1 & 300 & 1583 & 2701 & 0 & Reactor1 core load\\
       2 & 0 & 1583 & 2701 & 0 & \\
       3 & 400 & 2111 & 3601 & 100 & Reactor2 core load, Reactor1 refuel\\
       4 & 0 & 2111 & 3601 & 0 & \\
       5 & 100 & 528 & 901 & 200 & Reactor2 refuel\\
       6 & 0 & 528 & 901 & 500 & Reactor1 decom \\
       7 & 0 & 528 & 901 & 500 & \\
       8 & 0 & 528 & 901 & 800 & Reactor2 decom\\
       9 & 0 & 528 & 901 & 800 & \\
       \hline
    \end{tabularx}
    \caption {Analytical Solution}
    \label{tab:analytical}
\end{table}


\begin{table}[H]
    \centering
    \begin{tabularx}{\textwidth}{ssss}
       \hline
       & Deploy & Deploy & Deploy \\
       Timestep & Enrichment & Source & Sink  \\
       \hline
       1 & \textcolor{red}{1} & \textcolor{red}{1} & 0  \\
       2 & 0 & 0 & 0  \\
       3 & \textcolor{red}{1} & 0 & \textcolor{red}{1}  \\
       4 & 0 & \textcolor{red}{1} & 0  \\
       5 & 0 & 0 & 0  \\
       6 & 0 & 0 & \textcolor{red}{2}  \\
       7 & 0 & 0 & 0  \\
       8 & 0 & 0 & \textcolor{red}{1}  \\
       9 & 0 & 0 & 0  \\
       \hline
    \end{tabularx}
    \caption {Deployment Needs}
    \label{tab:deployment}
\end{table}

\begin{table}[H]
    \centering
    \begin{tabularx}{\textwidth}{sss}
    \hline 
    Time Step & Total Power Output [MWe] \\
    \hline 
    1 & 1000\\
    2 & 1000\\
    3 & 1000\\
    4 & 2000\\
    5 & 1000\\
    6 & 2000\\
    7 & 1000\\
    8 & 1000\\
    9 & 0\\
    10 & 0\\
    \end{tabularx}
    \caption {Total Power Output}
    \label{tab:poweroutput}
\end{table}

\subsection{Non-optimizing prediction method}
The following conditions need to be satisfied for each segment of the fuel cycle. The method to how each condition is tested is described. Tests written in C++ for each condition is included in Appendix A. 

\subsubsection{\texttt{Reactor}}

\begin{enumerate}
\item  \textit{Do all the \texttt{Reactor}s run at full capacity (not lacking fuel)?} \\
This is tested by determining the total number of time steps which both \texttt{Reactor}s are in operation, one \texttt{Reactor} is in operation or none is in operation. Based on the values of the analytical solution in Table \ref{tab:poweroutput}, there should be 2 time steps where both \texttt{Reactor}s are in operation, 6 time steps where only one \texttt{Reactor} is in operation and 2 time steps where no \texttt{Reactor}s are in operation. 

\item \textit{Is a new \texttt{Reactor} deployed when the energy demand exceeds the energy produced by the current \texttt{Reactor}s?} \\
This is tested by comparing the total number of \texttt{Reactor}s deployed to the analytical solution. Based on values of the analytical solution in Table \ref{tab:deployment}, in total 2 \texttt{Reactor}s were deployed.  

\item \textit{Is a \texttt{Reactor} decommissioned when the energy demand falls behind the output of the current \texttt{Reactor}s?} \\

\end{enumerate}

\subsubsection{\texttt{Enrichment}}
\begin{enumerate}
\item  \textit{Is the enriched uranium produced by \texttt{Enrichment} within the upper limit of [insert uncertainty] for the analytic solution of the enriched uranium required by the \texttt{Reactor} for each time step? } \\
This is tested by determining the total number of SWUs produced by the \texttt{Enrichment} facilities. These values are compared to the SWUs produced per time step in the analytical solution in Table \ref{tab:analytical}.
\item \textit{Is a new \texttt{Enrichment} facility deployed when the enriched uranium required by the \texttt{Fuelfab} exceeds the enriched uranium produced of current \texttt{Enrichment} facilities?} \\
This is tested by comparing the total number of \texttt{Enrichment} facilities deployed to the analytical solution. Based on values of the analytical solution in Table \ref{tab:deployment}, in total 2 \texttt{Enrichment} facilities were deployed.

\item Is a \texttt{Enrichment} decommissioned when the enriched uranium required by the \texttt{Fuelfab} falls behind the enriched uranium produced by current \texttt{Enrichment} facilities?
\end{enumerate}

\subsubsection{\texttt{Source}}
\begin{enumerate}
\item \textit{Is the mined uranium produced by \texttt{Source} within the upper limit of [insert uncertainty] for the analytic solution of the mined uranium required by the \texttt{Enrichment} facilities for each time step?} \\
This is tested by determining the total amount of Uranium mined by the \texttt{Source}. These values are compared to the Uranium produced per time step in the analytical solution in Table \ref{tab:analytical}.

\item \textit{Does the \texttt{Source} mined uranium produced increase when mined uranium required by the \texttt{Enrichment} facilities exceeds mined uranium produced by the current \texttt{Source}?} \\
This is tested by comparing the total number of \texttt{Source} facilities deployed to the analytical solution. Based on values of the analytical solution in Table \ref{tab:deployment}, in total 2 \texttt{Source} facilities were deployed.

\item Does the \texttt{Source} mined uranium produced decrease when mined uranium required by the \texttt{Enrichment} facilities falls behind the mined uranium required by the current \texttt{Source}?
\end{enumerate}

\subsection{Deterministic-Optimizing/Stochastic prediction method}
The following conditions need to be satisfied for each segment of the fuel cycle. 

\begin{enumerate}
\item Do all the \texttt{Reactor}s run? 
\begin{minted}{c++}
TEST(ReactorTests, DDDeploy_DO) {
    [Example input with the following attributes:]
        [int simdur = 20;]
        [Defines reactor with zero refueling cycle and operation 
        cycle of 1 month]
        [Defines fuel cycle facilities parameters]
        [Defines Reactor Deploy Scheme / Power Demand]
        [Increasing Fuel Demand with Time]
    [Run test]
    [Test if Reactor has no zero values in output Timeseriespower]
}
\end{minted}
\item  Do all the \texttt{Reactor}s run at full capacity (not lacking fuel)? 
\begin{minted}{c++}
TEST(ReactorTests, DDDeploy_DO) {
    [Example input with the following attributes:]
        [int simdur = 20;]
        [Defines reactor with zero refueling cycle, power capacity 
        of x and operation cycle of 1 month]
        [Defines fuel cycle facilities parameters]
        [Defines Reactor Deploy Scheme / Power Demand]
        [Increasing Fuel Demand with Time]
    [Run test]
    [Test if Reactor has x value in output Timeseriespower]
}
\end{minted}

\item Is the objective function optimized?

\item Is the constraint followed? 

\item  Do the related fuel cycle facilities get deployed upon demand?
\begin{minted}{xml}
TEST(ReactorTests, DDDeploy_NO) {
    [Example input with the following attributes:]
        [int simdur = 20;]
        [Defines reactor with zero refueling cycle and operation 
        cycle of 1 month]
        [Defines fuel cycle facilities parameters]
        [Defines Reactor Deploy Scheme / Power Demand]
        [Increasing Fuel Demand with Time]
    [Run test]
    [Test if fuel facility is deployed in the beginning]
    [Test if fuel facility is deployed later in the simulation 
    (have analytic solution)]
}
\end{minted}

\item Do the related fuel cycle facilities exit upon demand decrease?
\begin{minted}{xml}
TEST(ReactorTests, DDDeploy_NO) {
    [Example input with the following attributes:]
        [int simdur = 20;]
        [Defines reactor with zero refueling cycle and operation 
        cycle of 1 month]
        [Defines fuel cycle facilities parameters]
        [Defines Reactor Deploy Scheme / Power Demand]
        [Decreasing Fuel Demand with Time]
    [Run test]
    [Test if fuel facility is deployed in the beginning]
    [Test if fuel facility exits later in the simulation (have 
    analytic solution)]
}
\end{minted}


\end{enumerate}





\section{Advanced Fuel Cycles}


\section{Appendix A - Sample Test Code }
\subsection{Reactor}
\begin{enumerate}
\item  \textit{Do all the \texttt{Reactor}s run at full capacity (not lacking fuel)?}
\begin{minted}{C++}
TEST(ReactorTests, FullCapacity) {
   std::string config = 
     "  <fuel_inrecipes>  <val>fresh_uox</val>  </fuel_inrecipes>  "
     "  <fuel_outrecipes> <val>spent_uox</val>  </fuel_outrecipes>  "
     "  <fuel_incommods>  <val>uox</val> </fuel_incommods>  "
     "  <fuel_outcommods> <val>spent_uox</val>      </fuel_outcommods>  "
     "  <fuel_prefs>      <val>1.0</val>        </fuel_prefs>  "
     ""
     "  <cycle_time>2</cycle_time>  "
     "  <refuel_time>1</refuel_time>  "
     "  <assem_size>100</assem_size>  "
     "  <n_assem_core>3</n_assem_core>  "
     "  <n_assem_batch>1</n_assem_batch>  ";

  int simdur = 10 
  cyclus::MockSim sim(cyclus::AgentSpec(":cycamore:Reactor"),config
  ,simdur); 
  sim.AddSource("uox").Finalize();
  sim.AddRecipe("fresh_uox",c_uox());
  sim.AddRecipe("spent_uox".c_spentuox());
  int id. = sim.Run();

  int both_on = 2; 
  std::vector<Cond> conds; 
  conds.push_back(Cond("Value", "==",2000));
  QueryResult qr = sim.db().Query("TimeSeriesPower", &conds);
  EXPECT_EQ(both_on,qr.rows.size());  
  
  int one_on = 6; 
  std::vector<Cond> conds; 
  conds.push_back(Cond("Value", "==",1000));
  QueryResult qr = sim.db().Query("TimeSeriesPower", &conds);
  EXPECT_EQ(one_on,qr.rows.size());  

  int none_on = 2; 
  std::vector<Cond> conds; 
  conds.push_back(Cond("Value", "==",0));
  QueryResult qr = sim.db().Query("TimeSeriesPower", &conds);
  EXPECT_EQ(one_on,qr.rows.size());  
  }
\end{minted}

\item \textit{Is a new \texttt{Reactor} deployed when the energy demand exceeds the energy produced by the current \texttt{Reactor}s?} 
\begin{minted}{C++}
TEST(ReactorTests, DeployNew) {
   std::string config = 
     "  <fuel_inrecipes>  <val>fresh_uox</val>  </fuel_inrecipes>  "
     "  <fuel_outrecipes> <val>spent_uox</val>  </fuel_outrecipes>  "
     "  <fuel_incommods>  <val>uox</val> </fuel_incommods>  "
     "  <fuel_outcommods> <val>spent_uox</val>      </fuel_outcommods>  "
     "  <fuel_prefs>      <val>1.0</val>        </fuel_prefs>  "
     ""
     "  <cycle_time>2</cycle_time>  "
     "  <refuel_time>1</refuel_time>  "
     "  <assem_size>100</assem_size>  "
     "  <n_assem_core>3</n_assem_core>  "
     "  <n_assem_batch>1</n_assem_batch>  ";

  int simdur = 10 
  cyclus::MockSim sim(cyclus::AgentSpec(":cycamore:Reactor"),config,
  simdur); 
  sim.AddSource("uox").Finalize();
  sim.AddRecipe("fresh_uox",c_uox());
  sim.AddRecipe("spent_uox".c_spentuox());
  int id. = sim.Run();
  
  int reactors_deployed = 2; 
  std::vector<Cond> conds; 
  conds.push_back(Cond("String", "==",:cycamore:Reactor)); 
  QueryResult qr = sim.db().Query("AgentEntry", &conds);
  EXPECT_EQ(reactors_deployed,qr.rows.size());
  }
\end{minted}
\end{enumerate}
\end{document}



